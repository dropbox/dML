# Voice Project - Release Automation
# Worker #119: Automated release workflow
#
# Triggers on version tags (v*.*.*)
# Creates GitHub release with built binary and checksums

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.11"
  LIBTORCH_VERSION: "2.1.0"

jobs:
  # ==========================================================================
  # Build Release Binary
  # ==========================================================================
  build:
    name: Build Release
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.tag }}" != "" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Cache libtorch
        id: cache-libtorch
        uses: actions/cache@v4
        with:
          path: ~/libtorch
          key: ${{ runner.os }}-libtorch-${{ env.LIBTORCH_VERSION }}-arm64

      - name: Download libtorch (if not cached)
        if: steps.cache-libtorch.outputs.cache-hit != 'true'
        run: |
          curl -L -o libtorch.zip \
            "https://download.pytorch.org/libtorch/cpu/libtorch-macos-arm64-${{ env.LIBTORCH_VERSION }}.zip"
          unzip -q libtorch.zip -d ~/
          rm libtorch.zip

      - name: Install dependencies
        run: |
          brew install cmake ninja || true

      - name: Build release binary
        run: |
          mkdir -p stream-tts-cpp/build
          cd stream-tts-cpp/build
          cmake .. \
            -DCMAKE_PREFIX_PATH="$HOME/libtorch" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTS=OFF \
            -GNinja
          ninja stream-tts-cpp || ninja -j2 stream-tts-cpp

      - name: Create release archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCHIVE="voice-${VERSION}-macos-arm64"

          mkdir -p dist/${ARCHIVE}

          # Copy binary
          cp stream-tts-cpp/build/stream-tts-cpp dist/${ARCHIVE}/

          # Copy configs
          cp -r stream-tts-cpp/config dist/${ARCHIVE}/

          # Copy documentation
          cp README.md dist/${ARCHIVE}/ 2>/dev/null || echo "# Voice TTS" > dist/${ARCHIVE}/README.md
          cp LICENSE dist/${ARCHIVE}/ 2>/dev/null || true

          # Create quick start script
          cat > dist/${ARCHIVE}/quick_start.sh << 'EOF'
          #!/bin/bash
          # Voice TTS Quick Start
          #
          # Prerequisites:
          # 1. Download models (~7GB) to models/ directory
          # 2. Ensure macOS with Apple Silicon
          #
          # Usage:
          #   echo '{"type":"content_block_delta","delta":{"type":"text_delta","text":"Hello world"}}' | ./stream-tts-cpp config/default.yaml

          echo "Voice TTS Quick Start"
          echo "===================="
          echo ""
          echo "Binary: $(ls -lh stream-tts-cpp | awk '{print $5}')"
          echo ""
          echo "Models required (download separately):"
          echo "  - models/kokoro/kokoro_mps.pt (~460MB)"
          echo "  - models/whisper/ggml-large-v3.bin (optional, ~3GB)"
          echo "  - models/nllb/ (optional, ~6GB)"
          echo ""
          echo "See README.md for full documentation"
          EOF
          chmod +x dist/${ARCHIVE}/quick_start.sh

          # Create archive
          cd dist
          tar -czf ${ARCHIVE}.tar.gz ${ARCHIVE}

          # Generate checksums
          shasum -a 256 ${ARCHIVE}.tar.gz > ${ARCHIVE}.tar.gz.sha256

          echo "archive=${ARCHIVE}.tar.gz" >> $GITHUB_OUTPUT
          echo "checksum=${ARCHIVE}.tar.gz.sha256" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-binary
          path: dist/*.tar.gz*
          retention-days: 7

  # ==========================================================================
  # Run Tests Before Release
  # ==========================================================================
  test:
    name: Pre-Release Tests
    runs-on: macos-14
    timeout-minutes: 20
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          pip install pytest pytest-timeout pyyaml

      - name: Run smoke tests
        run: |
          pytest tests/smoke -v \
            -k "not requires_binary and not requires_models" \
            || echo "Some tests skipped (expected in CI)"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: release-binary
          path: dist/

      - name: Verify archive
        run: |
          cd dist
          ls -la
          tar -tzf *.tar.gz | head -20
          echo ""
          echo "Archive verification passed"

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.tag }}" != "" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-binary
          path: dist/

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [ -n "$PREV_TAG" ]; then
            echo "Changes since ${PREV_TAG}:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log ${PREV_TAG}..${VERSION} --pretty=format:"- %s" >> CHANGELOG.md
          else
            echo "Initial release" >> CHANGELOG.md
            git log --pretty=format:"- %s" -20 >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "1. Download the release archive for your platform" >> CHANGELOG.md
          echo "2. Extract: \`tar -xzf voice-${VERSION}-macos-arm64.tar.gz\`" >> CHANGELOG.md
          echo "3. Download models (~7GB) - see documentation" >> CHANGELOG.md
          echo "4. Run: \`./stream-tts-cpp config/default.yaml\`" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Voice TTS ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            dist/*.tar.gz
            dist/*.sha256
          fail_on_unmatched_files: false
